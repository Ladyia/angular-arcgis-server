!function(){"use strict";var e=angular.module("agsserver",[]);e.service("geojsonTools",function(){return{geoJsonFeature:function(e,t){var r={type:"Feature",properties:{},geometry:{type:t,coordinates:[]}};switch(t){case"Point":r.geometry.coordinates=[e.geometry.x,e.geometry.y];break;case"LineString":r.geometry.coordinates=e.geometry.paths[0];break;case"Polygon":r.geometry.coordinates=e.geometry.rings;break;default:return void console.log({error:"Improper geometry type"})}return r.properties=e.attributes,r},toGeojson:function(e){var t,r,o;o={type:"FeatureCollection",features:[]};try{if(e.features&&4326===e.spatialReference.wkid)t=e.features;else{if(4326!==e.results[0].geometry.spatialReference.wkid)throw{error:"Please set params outSR to 4326"};t=e.results}for(var a=0,n=t.length;n>a;a++)switch(r=t[a],e.geometryType||r.geometryType){case"esriGeometryPoint":o.features.push(this.geoJsonFeature(r,"Point"));break;case"esriGeometryPolyline":o.features.push(this.geoJsonFeature(r,"LineString"));break;case"esriGeometryPolygon":o.features.push(this.geoJsonFeature(r,"Polygon"));break;default:throw{error:"esri geometry not recognized, failed geojson conversion"}}}catch(s){console.log(s)}finally{return o}}}}),e.factory("Ags",["$cacheFactory","$http","$q","geojsonTools",function(e,t,r,o){var a=e("base"),n=function(e,t){var r;return t=t.trim(),e.forEach(function(e){t===e.name&&(r=e.id)}),r},s=function(e,t){var r=["all","visible","top",""];if(-1===r.indexOf(t)){var o=t.split(","),a=o.map(function(t){var r=/^\d+$/.test(t);return r?t:n(e,t)});return a}return t},i=function(e){return this.conn={protocol:e.protocol||"http",host:e.host||"",path:e.path||"/arcgis/rest/services"},this};return i.prototype={resetConn:function(e){return angular.extend(this.conn,e),this},getConn:function(){var e=this.conn,t=e.protocol+"://"+e.host+e.path;return t},actions:[{type:"query",method:"GET"},{type:"applyEdits",method:"POST"},{type:"addFeatures",method:"POST"},{type:"updateFeatures",method:"POST"},{type:"deleteFeatures",method:"POST"},{type:"generateRenderer",method:"GET"},{type:"identify",method:"GET"},{type:"find",method:"GET"},{type:"export",method:"GET"}],setService:function(e){try{if("object"!=typeof e)throw{error:"Options is not an object!"};if(e==={})throw{error:"Options are empty"}}catch(t){console.log(t)}var r=this.getConn(),o=r+"/"+e.folder+"/"+e.service+"/"+e.server,a=new i(this.conn);return a.serviceUrl=o,a},layers:[],setRequst:function(e,t,r){var o;return r.actions?this.actions.forEach(function(a){a.type===r.actions&&(o={method:a.method,url:t||0===t?e+"/"+t+"/"+a.type:e+"/"+a.type,headers:r.headers||{"Content-Type":"text/plain"},params:r.params||{},timeout:r.timeout||5e3},"POST"===a.method&&(o.params.features=JSON.stringify(o.params.features)))}):o={method:"GET",url:t||0===t?e+"/"+t:e,headers:r.headers||{"Content-Type":"text/plain"},params:r.params||{f:"json"},timeout:r.timeout||5e3},o},utilsGeom:function(e,o){try{if("object"!=typeof o)throw{error:"Options is not an object!"};if(o==={})throw{error:"Options are empty"}}catch(a){console.log(a)}var n,s,i=this,c=i.getConn();return n=c+"/Utilities/Geometry/GeometryServer/"+e,s={params:o,header:{"Content-Type":"text/plain"}},t.post(n,s).then(function(e){return e.data},function(e){return r.reject(e.data)})},request:function(e){try{if("object"!=typeof e)throw{error:"Options is not an object!"};if(e==={})throw{error:"Options are empty"}}catch(i){console.log(i)}var c=this,u=c.getConn(),l={params:{f:"json"},cache:a},p=this.serviceUrl||u+"/"+e.folder+"/"+e.service+"/"+e.server;return t.get(p,l).then(function(t){if("object"!=typeof t.data||t.data.error)return console.log(t.data.error),r.reject(t.data);var o=t.data.layers.concat(t.data.tables);if(c.layers=0===c.layers.length?[{folder:e.folder,service:[{name:e.service,server:e.server,layers:o}]}]:c.layers,e.layer){var a=n(o,e.layer);return"number"==typeof a?a:r.reject(t.data)}switch(e.actions){case"find":case"identify":case"export":e.params.layers&&(e.params.layers=s(o,e.params.layers));break;default:return}},function(e){return r.reject(e.data)}).then(function(a){var n=c.setRequst(p,a,e);return t(n).then(function(t){return"object"==typeof t.data?e.geojson===!0?o.toGeojson(t.data):t.data:(console.log("invalide response"),r.reject(t.data))},function(e){return console.log({error:"Promise rejected - Check your options and server"}),r.reject(e.data)})})},requestToken:function(e){var o={request:"getToken"};angular.extend(o,e);var a=this.conn,n=a.protocol+"://"+a.host+"/arcgis/tokens/",s=r.defer();return t({method:"POST",url:n,data:$.param(o),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){s.resolve(e.token)}),s.promise},authRequest:function(e){var i=this,c=i.getConn(),u={params:{f:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}},cache:a},l=this.serviceUrl||c+"/"+e.folder+"/"+e.service+"/"+e.server;return t.post(l,u).then(function(t){if("object"!=typeof t.data||t.data.error)return console.log(t.data.error),r.reject(t.data);var o=t.data.layers.concat(t.data.tables);if(i.layers=0===i.layers.length?[{folder:e.folder,service:[{name:e.service,server:e.server,layers:o}]}]:i.layers,e.layer){var a=n(o,e.layer);return"number"==typeof a?a:r.reject(t.data)}switch(e.actions){case"find":case"identify":case"export":e.params.layers&&(e.params.layers=s(o,e.params.layers));break;default:return}},function(e){return r.reject(e.data)}).then(function(a){var n=i.setRequst(l,a,e);return t(n).then(function(t){return"object"==typeof t.data?e.geojson===!0?o.toGeojson(t.data):t.data:(console.log("invalide response"),r.reject(t.data))},function(e){return console.log({error:"Promise rejected - Check your options and server"}),r.reject(e.data)})})}},i}])}();